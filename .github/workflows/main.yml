name: Mandarin server CI/CD (Maven)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  S3_BUCKET_NAME: mandarin-deploy
  ARTIFACT_NAME: mandarin_backend-0.0.1-SNAPSHOT.jar

jobs:
  build_and_deploy:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
    
    - name: Set up JDK 17
      uses: actions/setup-java@v3
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'maven'
        
    - name: Build with Maven and Inject Secrets
      run: mvn clean package
      env: 
        SPRING_DATASOURCE_URL: ${{ secrets.DB_URL }}
        SPRING_DATASOURCE_USERNAME: ${{ secrets.DB_USERNAME }}
        SPRING_DATASOURCE_PASSWORD: ${{ secrets.DB_PASSWORD }}
        
    - name: Make Deployment Directory
      run: mkdir -p deploy
      
    - name: Copy Jar to deploy folder
      run: cp ./target/${{ env.ARTIFACT_NAME }} ./deploy/
      
    - name: Make zip file
      run: zip -r mandarin.zip deploy/
      shell: bash

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ap-northeast-2

    - name: Upload zip to S3
      run: aws s3 cp --region ap-northeast-2 ./mandarin.zip s3://${{ env.S3_BUCKET_NAME }}/

    - name: Execute remote deployment script
      uses: appleboy/ssh-action@v0.1.10
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        port: ${{ secrets.SSH_PORT }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          chmod +x /home/${{ secrets.SSH_USERNAME }}/deploy.sh
          /home/${{ secrets.SSH_USERNAME }}/deploy.sh
