name: Mandarin server CI/CD (Maven)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  S3_BUCKET_NAME: mandarin-deploy
  ARTIFACT_NAME: mandarin_backend-0.0.1-SNAPSHOT.jar

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: "17"
          distribution: "temurin"
          cache: "maven"

      - name: Build with Maven
        # [수정됨] -DskipTests 옵션을 추가하여 테스트(DB연결) 없이 빌드만 수행
        run: mvn clean package -DskipTests
        # [삭제됨] 빌드 단계에서는 DB 접속 정보가 필요 없으므로 env 블록 삭제함

      - name: Make Deployment Directory
        run: mkdir -p deploy

      - name: Copy Jar to deploy folder
        run: cp ./target/${{ env.ARTIFACT_NAME }} ./deploy/

      - name: Make zip file
        run: zip -r mandarin.zip deploy/
        shell: bash

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-2

      - name: Upload zip to S3
        run: aws s3 cp --region ap-northeast-2 ./mandarin.zip s3://${{ env.S3_BUCKET_NAME }}/

      - name: Execute remote deployment script (with DB secrets)
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USERNAME }}
          port: ${{ secrets.SSH_PORT }}
          key: ${{ secrets.SSH_KEY }}
          timeout: 30m # 배포 스크립트가 길어질 경우를 대비해 넉넉히 잡음
          # DB 연결을 위한 환경 변수를 원격 셸 세션에 export
          script: |
            # SPRING_DATASOURCE_URL 환경 변수를 secrets에서 가져와 EC2 서버 셸에 설정합니다.
            export SPRING_DATASOURCE_URL="${{ secrets.DB_URL }}"
            export SPRING_DATASOURCE_USERNAME="${{ secrets.DB_USERNAME }}"
            export SPRING_DATASOURCE_PASSWORD="${{ secrets.DB_PASSWORD }}"

            # 배포 스크립트 실행
            chmod +x /home/${{ secrets.SSH_USERNAME }}/deploy.sh
            /home/${{ secrets.SSH_USERNAME }}/deploy.sh
